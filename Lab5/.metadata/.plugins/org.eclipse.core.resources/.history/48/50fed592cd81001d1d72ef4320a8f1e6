/*
 * uart_fsm.c
 *
 *  Created on: Dec 12, 2022
 *      Author: ADMIN
 */
#include "uart_fsm.h"
#include "main.h"
#include "global.h"
#include <stdio.h>


char str[20];

void resetbuffer(){
	for(int i=0;i<MAX_BUFFER_SIZE;i++){
		buffer[i]=0;
	}
	index_buffer = 0;
}

void command_parser_fsm(){
	if(index_buffer>=4){
		  if(buffer[0]=='!' && buffer[1]=='R' && buffer[2]=='S' && buffer[3]=='T' && buffer[4]=='#'){
			  status=1;
		  }
	}
	 else if(index_buffer==3){
		  if(buffer[0]=='!' && buffer[1]=='O' && buffer[2]=='K' && buffer[3]=='#'){
			  status=1;
		  }
	 }



	  if(buffer[0]=='!' && (buffer[4]=='#' || buffer[3]=='#')){
		  if(buffer[1]=='R' && buffer[2]=='S' && buffer[3]=='T'){
			  status=1;
		  }

		  else if(buffer[1]=='O' && buffer[2]=='K'){
			  status=2;
		  }
		  else  resetbuffer();
	  }
	  else resetbuffer();

	/////////////////////////////////
	  HAL_GPIO_TogglePin(LED_GREEN_GPIO_Port, LED_RED_Pin);
}
void uart_communiation_fsm(){
	ADC_value= HAL_ADC_GetValue(&hadc1);
//	HAL_UART_Transmit(&huart2, (void *)str, sprintf(str,"%d\r\n",ADC_value), 1000);
	  if(timer1_flag == 1){
		  switch(status){
			  case 1:
				  if(buffer[5]==13){
					  HAL_UART_Transmit(&huart2, (void *)str, sprintf(str,"%d\r\n",ADC_value), 20);
					  HAL_UART_Transmit(&huart2, buffer, 3, 1000);
					  resetbuffer();
				  }
				  break;
			  case 2:
				  HAL_UART_Transmit(&huart2, buffer, 4, 1000);
				  if(buffer[4]==13) resetbuffer();
				  break;
		  }
		  setTimer1(500);
	  }
}


